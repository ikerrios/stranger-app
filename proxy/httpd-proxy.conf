SSLProxyEngine On

<VirtualHost *:80>
    ServerName localhost

    ProxyPreserveHost Off
    ProxyRequests Off
    ProxyTimeout 300
    
    # Prevenir bucles de proxy
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
    RequestHeader set X-Forwarded-Proto "https"
    
    # Detectar y prevenir bucles
    SetEnvIf X-Forwarded-For ".*" forwarded=yes
    
    # Headers para CORS
    Header set Access-Control-Allow-Origin "*"

    # --- API → Spring Boot Backend ---
    RewriteEngine On
    
    # Solo hacer proxy de /api si no viene de otro proxy
    RewriteCond %{ENV:forwarded} !^yes$
    RewriteRule ^/api/(.*)$ https://stranger-app-po8w.onrender.com/api/$1 [P,L]
    ProxyPassReverse "/api/" "https://stranger-app-po8w.onrender.com/api/"

    # --- Todo lo demás → PHP Frontend ---
    # Solo hacer proxy si no viene de otro proxy
    RewriteCond %{ENV:forwarded} !^yes$
    RewriteRule ^/(.*)$ https://stranger-app-1.onrender.com/$1 [P,L]
    ProxyPassReverse "/" "https://stranger-app-1.onrender.com/"

    # Logs para debugging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 common
    LogLevel warn rewrite:trace3
</VirtualHost>